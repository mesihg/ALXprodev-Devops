#!/bin/bash

# Variables
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon") # Pokémon list
API_URL="https://pokeapi.co/api/v2/pokemon"
ERROR_FILE="errors.txt"

DELAY_SECONDS=2 # Delay between requests to avoid rate limiting
MAX_RETRIES=3   # Maximum number of retry attempts per Pokémon
RETRY_DELAY=2   # Initial delay between retries


# Log errors to errors.txt
log_error() {
    # $1: the message passed to the function
    local error_message="$1"
    local pokemon_name="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    # prepend with timestamp and append the error message to the error log file
    echo "[$timestamp] - ERROR [$pokemon_name]: $error_message" >> "$ERROR_FILE"
}
fetch_data() {
    local POKEMON_NAME="$1"
    local API_URL="${API_URL}${POKEMON_NAME}"
    local OUTPUT_FILE="${POKEMON_NAME}.json"
    local attempt=1
    local max_attempts=$((MAX_RETRIES + 1))  # +1 for initial attempt
    

    echo "Trying to fetch data for ${POKEMON_NAME}..."
    while [[ $attempt -le $max_attempts ]]; do
        if [[ $attempt -gt 1 ]]; then
            local retry_delay=$((RETRY_DELAY * (2 ** (attempt - 2))))
            echo -e "$Retry attempt $((attempt - 1))/$MAX_RETRIES for $POKEMON_NAME"
            sleep $retry_delay
        fi
        local response 
        response=$(curl -s -S -f -w "%{http_code}" --connect-timeout 10 --max-time 30 "$API_URL/$POKEMON_NAME" 2>/dev/null)
        local curl_exit_code=$?

        if [[ $curl_exit_code -ne 0 ]]; then
            local error_message = "Network error: curl failed with exit code $curl_exit_code"

            if [[ $attempt -eq $max_attempts ]]; then
                log_error "$error_message (all $MAX_RETRIES retries exhausted)" "$POKEMON_NAME"
                return 1
            else
                echo -e "Network error for $POKEMON_NAME"
                ((attempt++))
                continue
            fi
        fi
        
        local status_code="${response: -3}" # Last 3 characters (the status code)
        response="${response%???}"  # All the response except the last 3 characters

        # Check the HTTP status code
        if ["$status_code" -eq 200 ]; then
            echo "$response" > "$OUTPUT_FILE"
            echo "Data saved to ${OUTPUT_FILE}"
            return 0
        else
            if [[ $attempt -eq $max_attempts ]]; then
                log_error "$error_message (all $MAX_RETRIES retries exhausted)" "$POKEMON_NAME"
                return 1
            else
                echo -e "Invalid JSON for $POKEMON_NAME (attempt $attempt/$max_attempts)${NC}"
                ((attempt++))
                continue
            fi
        fi

}

for name in "${POKEMON_LIST[@]}"; do
    fetch_data "$name"
    if [[ "$name" != "${POKEMON_LIST[-1]}" ]]; then
        sleep "$DELAY_SECONDS"
    fi
done

echo "Batch retrieval complete."